function LabelRegion(a){this.setValues(a);var b=this.span_=document.createElement("span");b.className="labelRegion";var c=this.div_=document.createElement("div");c.appendChild(b),c.style.cssText="position: absolute; zIndex : 201;"}function Station(a){this.setValues(a);var b=this.span_=document.createElement("span"),c=this.div_=document.createElement("div");c.appendChild(b),c.style.cssText="position: absolute; zIndex : 200;"}function gup(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.href);return null==d?"":d[1]}function switchSkiType(){"soir"==skitype?mapStyle[0].stylers[0].invert_lightness=!0:"jour"==skitype&&(mapStyle[0].stylers[0].invert_lightness=!1)}function addStatus(a){var b=a;"0"==b.assq||1==b.etatMontagne&&b.MiseAJour&&!((new Date).getTime()-new Date(b.MiseAJour).getTime()<=1728e5)?(b.status="indetermine",b.pistesOuvertesJourForView="?",b.pistesOuvertesSoirForView="?",b.surfacePistesForView="indéterminé",b.basePistesForView="indéterminé",b.couverturePistesForView="indéterminé",b.precipitations24heuresForView="?",b.precipitations48heuresForView="?",b.precipitations7joursForView="?"):0==b.etatMontagne||0==b.pistesOuvertesJour&&0==b.pistesOuvertesSoir?(b.status="ferme",b.pistesOuvertesJourForView="0",b.pistesOuvertesSoirForView="0",b.surfacePistesForView="indéterminé",b.basePistesForView="indéterminé",b.couverturePistesForView="indéterminé",b.precipitations24heuresForView="?",b.precipitations48heuresForView="?",b.precipitations7joursForView="?"):"jour"==skitype&&0==b.pistesOuvertesJour||"soir"==skitype&&0==b.pistesOuvertesSoir?(b.status="ferme",b.pistesOuvertesJourForView=b.pistesOuvertesJour,b.pistesOuvertesSoirForView=b.pistesOuvertesSoir,b.surfacePistesForView=b.surfacePistes,b.basePistesForView=b.basePistes,b.couverturePistesForView=b.couverturePistes,b.precipitations24heuresForView=b.precipitations24heures,b.precipitations48heuresForView=b.precipitations48heures,b.precipitations7joursForView=b.precipitations7jours):(b.status="ouvert",b.pistesOuvertesJourForView=b.pistesOuvertesJour,b.pistesOuvertesSoirForView=b.pistesOuvertesSoir,b.surfacePistesForView=b.surfacePistes,b.basePistesForView=b.basePistes,b.couverturePistesForView=b.couverturePistes,b.precipitations24heuresForView=b.precipitations24heures,b.precipitations48heuresForView=b.precipitations48heures,b.precipitations7joursForView=b.precipitations7jours)}function getOuverture(a){var b=a,c=0,d="";if("ouvert"==b.status){var e=skitype.charAt(0).toUpperCase()+skitype.slice(1);proportion=b["pistesOuvertes"+e]/b["pistesTotal"+e],0!=proportion?(proportion>0?c=20:proportion>.2?c=80:proportion>.8&&(c=100),d=icones.stations.ouverture["ouvert"+c]):d=icones.stations.ouverture.iconeferme}else"ferme"==b.status?d=icones.stations.ouverture.iconeferme:"indetermine"==b.status&&(d=icones.stations.ouverture.iconend);return d}function getSnowFallIcon(a){var b=a,c=b[mode],d="1cm";return"ferme"!=b.status&&"indetermine"!=b.status?(c>=20?d="30cm":c>=10?d="10cm":c>=5?d="1cm":c>=0&&(d="dame"),icones.stations.neige["icone"+d]):getOuverture(a)}function getModeMeteoConvert(a){var b,c=a;switch(mode){case"meteo-ce-soir":b="MMD0ICON";break;case"meteo-demain":b="MMD1ICON";break;case"meteo-apres-demain":b="MMD2ICON"}return"ico-icone-"+c[b]}function getIcone(a){switch(mode){case"ouverture":return getOuverture(a);case"precipitations24heures":case"precipitations48heures":case"precipitations7jours":return getSnowFallIcon(a);case"meteo-ce-soir":case"meteo-demain":case"meteo-apres-demain":return getModeMeteoConvert(a)}}function filtreNuit(a){return thisMarker=a,"soir"==skitype&&0==thisMarker.pistesTotalSoir?!1:!0}function setVisibility(a){return thisMarker=a,showClosed!==!1||"ferme"!=a.status&&"indetermine"!=a.status?"soir"==skitype&&0==thisMarker.pistesTotalSoir?!1:!0:!1}function initMap(){switchSkiType(),google.maps.visualRefresh=!0;var a=gup("region");""!=a&&$.each(markers,function(b,c){c.type==a&&(centerLatitude=c.latitude,centerLongitude=c.longitude,startZoom=parseInt(c.zoom))}),mapOptions={zoom:startZoom,center:new google.maps.LatLng(centerLatitude,centerLongitude),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:mapStyle,scrollwheel:!1,scaleControl:!0,zoomControl:!0,panControl:!1,overviewMapControl:!1,mapTypeControl:!1,disableDefaultUI:!1,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP],style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR}},map=new google.maps.Map(document.getElementById("map"),mapOptions);var b=document.getElementById("container-ctrl");b.style.display="block";var c=new google.maps.InfoWindow({content:""});$.each(markers,function(a,b){if(0==b.vln&&"tqc"!=b.type){var d=new LabelRegion({map:map});d.set("position",new google.maps.LatLng(b.latitude,b.longitude)),d.set("text",b.codepostal),d.set("data",b),d.set("visible",!1),labelRegionArray.push(d)}else if("tqc"!=b.type){addStatus(b);var e=new Station({map:map});e.set("position",new google.maps.LatLng(b.latitude,b.longitude)),e.set("text",b.codepostal),e.set("data",b),e.set("visible",setVisibility(b)),e.set("classname",getIcone(b));var f=parseTemplate($("#tpml-info-window-night").html(),b),g=parseTemplate($("#tpml-info-window-day").html(),b);google.maps.event.addListener(e,"click",function(){"jour"==skitype?c.setContent(g):"soir"==skitype&&c.setContent(f),c.open(map,e)}),stationsArray.push(e)}})}function handleResize(){var a=$(window).height();$("#map").height(a+"px"),$("#sidebar").height(a+"px")}function afficherStations(){var a=$("#montagnes");$.each(markers,function(b,c){0==b&&(c.codepostal="Tout le Québec"),0==c.vln?a.append('<h3 class="region-title">'+c.codepostal+"</h3>"):a.append('<div class="selector-mountain">'+c.codepostal+"</div>")}),a.children().each(function(){$(this).click(function(){var a=$(this),b=a.text();$.each(stationsArray,function(a,c){if(b==c.data.codepostal){google.maps.event.trigger(c,"click");var d=new google.maps.LatLng(c.data.latitude,c.data.longitude);map.panTo(d)}}),$.each(labelRegionArray,function(a,c){if(b==c.data.codepostal){zoom=parseInt(c.data.zoom);var d=new google.maps.LatLng(c.data.latitude,c.data.longitude);map.panTo(d),map.setZoom(zoom)}else if("Tout le Québec"==b){var d=new google.maps.LatLng(centerLatitude,centerLongitude);map.panTo(d),map.setZoom(startZoom)}})})})}!function(){var a={};this.parseTemplate=function(b,c){var d="";try{var e=a[b];if(!e){var f="var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").replace(/'(?=[^#]*#>)/g,"	").split("'").join("\\'").split("	").join("'").replace(/<#=(.+?)#>/g,"',$1,'").split("<#").join("');").split("#>").join("p.push('")+"');}return p.join('');";e=new Function("obj",f),a[b]=e}return e(c)}catch(g){d=g.message}return"< # ERROR: "+d.htmlEncode()+" # >"}}();var map,markers=[],labelRegionArray=[],mapOptions={},stationsArray=[],currentInfoWindow,currentListItem,centerLatitude=46.972756,centerLongitude=-71.905518,startZoom=7,skitype=(new Date).getHours()<15?"jour":"soir",mode="ouverture",showRegs=!1,showClosed=!1,icones={iconevide:"icones/vide.png",stations:{ouverture:{iconend:"ico-nd",iconeferme:"ico-ferme",ouvert100:"ico-ouvert100",ouvert80:"ico-ouvert80",ouvert20:"ico-ouvert20",ouvert0:"ico-ferme"},neige:{iconedame:"ico-dame",icone1cm:"ico-1cm",icone10cm:"ico-10cm",icone30cm:"ico-30cm"},meteo:{meteoPas:"ico-meteo_Pas",meteoPluieFaible:"ico-meteo_PluieFaible",meteoPluieMoyenne:"ico-meteo_PluieMoyenne",meteoPluieGrosse:"ico-meteo_PluieGrosse",meteoNeigeFaible:"ico-meteo_NeigeFaible",meteoNeigeMoyenne:"ico-meteo_NeigeMoyenne",meteoNeigeGrosse:"ico-meteo_NeigeGrosse",meteoMixte:"ico-meteo_Mixte"}}},mapStyle=[{featureType:"all",elementType:"all",stylers:[{invert_lightness:!1},{weight:.3},{hue:"#00b2ff"}]}];LabelRegion.prototype=new google.maps.OverlayView,LabelRegion.prototype.onAdd=function(){var a=this.getPanes().overlayLayer;a.appendChild(this.div_);var b=this;this.listeners_=[google.maps.event.addListener(this,"position_changed",function(){b.draw()}),google.maps.event.addListener(this,"text_changed",function(){b.draw()}),google.maps.event.addListener(this,"visible_changed",function(){b.draw()})]},LabelRegion.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);for(var a=0,b=this.listeners_.length;b>a;++a)google.maps.event.removeListener(this.listeners_[a])},LabelRegion.prototype.draw=function(){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.get("position")),c=this.div_;c.style.left=b.x+"px",c.style.top=b.y+"px",this.span_.innerHTML=this.get("text").toString(),this.get("visible")===!0?c.style.display="block":this.get("visible")===!1&&(c.style.display="none")},Station.prototype=new google.maps.OverlayView,Station.prototype.onAdd=function(){var a=this.getPanes().overlayLayer;a.appendChild(this.div_);var b=this;this.listeners_=[google.maps.event.addListener(this,"position_changed",function(){b.draw()}),google.maps.event.addListener(this,"classname_changed",function(){b.draw()}),google.maps.event.addListener(this,"text_changed",function(){b.draw()}),google.maps.event.addListener(this,"visible_changed",function(){b.draw()}),google.maps.event.addDomListener(this.div_,"click",function(){google.maps.event.trigger(b,"click")})]},Station.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_);for(var a=0,b=this.listeners_.length;b>a;++a)google.maps.event.removeListener(this.listeners_[a])},Station.prototype.draw=function(){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.get("position")),c=this.div_;c.style.left=b.x+"px",c.style.top=b.y+"px",this.span_.className=this.get("classname"),this.span_.title=this.get("text"),this.get("visible")===!0?c.style.display="block":this.get("visible")===!1&&(c.style.display="none")},$(document).ready(function(){$("#filters-map").find(".js-reveal").each(function(){$(this).click(function(a){var b=$(this).attr("href"),c=$("#container-ctrl"),d=$(".js-reveal"),e=$(".js-reveal-content");a.preventDefault(),"#toogle"==b||$(this).hasClass("is-open")?c.hasClass("is-open")?(c.removeClass("is-open"),d.removeClass("is-open")):(c.addClass("is-open"),e.each(function(){if($(this).hasClass("is-open")){var a=$(this).attr("id");$('.js-reveal[href="#'+a+'"]').addClass("is-open")}})):(e.hide().removeClass("is-open"),d.removeClass("is-open"),$(b).show().addClass("is-open"),$(this).addClass("is-open"),c.addClass("is-open"))})}),$("#choix-skitype").find("input[type=radio]").each(function(){$(this).val()==skitype&&$(this).attr("checked",!0),$(this).change(function(){skitype=$(this).val(),switchSkiType(),mapOptions.styles=mapStyle,mapOptions.center=map.getCenter(),mapOptions.zoom=map.getZoom(),map.setOptions(mapOptions),$.each(stationsArray,function(a,b){addStatus(b.data),b.set("visible",setVisibility(b.data)),b.set("classname",getIcone(b.data))})})}),$("#choix-cache-regions").find("input[type=checkbox]").change(function(){var a=$(this),b=$("#choix-cache-regions").find(".js-text");"hidden"==a.data("status")?(a.data("status","visible"),b.html(a.data("text").visible)):(a.data("status","hidden"),b.html(a.data("text").hidden)),$.each(labelRegionArray,function(b,c){"hidden"==a.data("status")?c.set("visible",!1):"visible"==a.data("status")&&c.set("visible",!0)})}),$("#choix-cache-stations").find("input[type=checkbox]").change(function(){var a=$(this),b=$("#choix-cache-stations").find(".js-text");"hidden"==a.data("status")?(a.data("status","visible"),b.html(a.data("text").hidden),showClosed=!0):(a.data("status","hidden"),b.html(a.data("text").visible),showClosed=!1),$.each(stationsArray,function(a,b){b.set("visible",setVisibility(b.data))})}),$("#choix-vues").find("input[type=radio]").each(function(){$(this).click(function(){mode=$(this).data("mode"),$.each(stationsArray,function(a,b){b.set("classname",getIcone(b.data))})})}),handleResize(),$(window).resize(function(){handleResize()}),$.getJSON("http://zoneski.com/skimaptw13/jsonp.php?callback=?",function(a){markers=a,markers?(afficherStations(),google.maps.event.addDomListener(window,"load",initMap())):$("#alert").html("<p>Erreur de données.</p>")}).fail(function(){$("#alert").html("<p>Impossible d'accéder aux données de la carte.</p>")})});